version: '3.8'

services:
  # PostgreSQL Database with Auth Schema
  db:
    image: postgres:15-alpine
    container_name: percentage-tool-db
    restart: always
    environment:
      POSTGRES_USER: pertool
      POSTGRES_PASSWORD: pertool
      POSTGRES_DB: postgres
    ports:
      - "5433:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
      # Mount supabase/setup.sql to auto-run during first startup
      # PostgreSQL runs SQL files in /docker-entrypoint-initdb.d/ alphabetically
      - ../supabase/setup.sql:/docker-entrypoint-initdb.d/01-setup.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pertool"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Prisma Client Generation
  # Note: Schema is automatically initialized by postgres container
  #       This service just generates Prisma Client for the app
  migrations:
    image: node:20-alpine
    container_name: percentage-tool-migrations
    working_dir: /app
    volumes:
      - ..:/app
    environment:
      DATABASE_URL: postgresql://pertool:pertool@db:5432/postgres
    command: >
      sh -c "
        echo 'Waiting for database initialization...' &&
        sleep 5 &&
        echo 'Installing dependencies...' &&
        npm install &&
        echo 'Generating Prisma Client...' &&
        npx prisma generate &&
        echo 'Prisma Client ready!'
      "
    depends_on:
      db:
        condition: service_healthy

  # The Next.js Application
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: runner
    container_name: percentage-tool-app
    restart: always
    ports:
      - "3000:3000"
    env_file:
      - ../.env.docker
    environment:
      - NODE_ENV=production
      - HOSTNAME=0.0.0.0
      - DATABASE_URL=postgresql://pertool:pertool@db:5432/postgres
      # Supabase environment variables (using mock keys for Docker)
      - NEXT_PUBLIC_SUPABASE_URL=http://localhost:3000
      - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=mock-publishable-key-for-docker
      - SUPABASE_SERVICE_ROLE_KEY=mock-service-role-key-for-docker
      # AI settings - assumes LM Studio running on host
      - AI_HOST=http://host.docker.internal:1234/v1
      - LLM_MODEL=${LLM_MODEL:-meta-llama-3.1-8b-instruct}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-nomic-embed-text-v1.5}
    depends_on:
      migrations:
        condition: service_completed_successfully
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Optional: Prisma Studio for database management
  studio:
    image: node:20-alpine
    container_name: percentage-tool-studio
    working_dir: /app
    ports:
      - "5555:5555"
    volumes:
      - ..:/app
    environment:
      DATABASE_URL: postgresql://pertool:pertool@db:5432/postgres
    command: >
      sh -c "
        npm install &&
        npx prisma generate &&
        npx prisma studio --hostname 0.0.0.0
      "
    depends_on:
      - db
    profiles:
      - tools

volumes:
  db_data:
